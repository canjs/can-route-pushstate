<!DOCTYPE html>

<html>
<head>
  <title>can-route-pushstate.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="can-route-pushstate-js">can-route-pushstate.js</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Plugin for <code>route</code> which uses browser <code>history.pushState</code> support
to update window’s pathname in addition to <code>hash</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>On a high-level, <code>can-route-pushstate</code> creates an observable type, 
<code>PushstateObservable</code>, that changes when <code>history.pushState</code> is called.
It does this by:</p>
<ul>
<li>Intercepting <code>click</code> events on anchor elements (‘<a>‘) when the
<code>.href</code> matches a routing rule.</li>
<li>Decorating <code>replaceState</code> and <code>pushState</code> to dispatch observable
event handlers when called.</li>
<li>Listen to <code>popstate</code> events and dispatch obserevable event handlers.</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><code>PushstateObservable</code> inherits from <code>SimpleObservable</code>, most of
<code>PushstateObservable</code>‘s “observable” logic comes from <code>SimpleObservable</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/*jshint maxdepth:6, scripturl:true*/</span>
<span class="hljs-meta">"use strict"</span>;
<span class="hljs-keyword">var</span> route = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-route"</span>);
<span class="hljs-keyword">var</span> bindingProxy = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-route/src/binding-proxy"</span>);
<span class="hljs-keyword">var</span> canReflect = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-reflect"</span>);
<span class="hljs-keyword">var</span> canSymbol = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-symbol"</span>);

<span class="hljs-keyword">var</span> SimpleObservable = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-simple-observable"</span>);
<span class="hljs-keyword">var</span> ObservationRecorder = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-observation-recorder"</span>);

<span class="hljs-keyword">var</span> isNode = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-globals/is-node/is-node"</span>);
<span class="hljs-keyword">var</span> LOCATION = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-globals/location/location"</span>);
<span class="hljs-keyword">var</span> getDocument = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-globals/document/document"</span>);
<span class="hljs-keyword">var</span> getGlobal = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-globals/global/global"</span>);

<span class="hljs-keyword">var</span> domEvents = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-dom-events"</span>);

<span class="hljs-keyword">var</span> diffObject = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-diff/map/map"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="methodstooverwrite">methodsToOverwrite</h2>
<p>Method names on <code>history</code> that will be overwritten
during teardown these are reset to their original functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> methodsToOverwrite = [<span class="hljs-string">"pushState"</span>, <span class="hljs-string">"replaceState"</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>This symbol is used in dispatchHandlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	dispatchSymbol = canSymbol.for(<span class="hljs-string">"can.dispatch"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="helpers">Helpers</h2>
<p>The following are helper functions useful to <code>can-route-pushstate</code>‘s main methods.</p>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3 id="cleanroot">cleanRoot</h3>
<p>Start of <code>location.pathname</code> is the root. 
Returns the root minus the domain.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanRoot</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">var</span> location = LOCATION(),
		domain = location.protocol + <span class="hljs-string">"//"</span> + location.host,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>pulls root from route.urlData</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		root = bindingProxy.call(<span class="hljs-string">"root"</span>),
		index = root.indexOf(domain);

	<span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
		<span class="hljs-keyword">return</span> root.substr(domain.length);
	}
	<span class="hljs-keyword">return</span> root;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="getcurrenturl">getCurrentUrl</h3>
<p>Gets the current url after the root.
<code>root</code> is defined in the PushstateObservable constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCurrentUrl</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">var</span> root = cleanRoot(),
		location = LOCATION(),
		loc = (location.pathname + location.search),
		index = loc.indexOf(root);

	<span class="hljs-keyword">return</span> loc.substr(index + root.length);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="pushstateobservable">PushstateObservable</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PushstateObservable</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Keys passed into <code>replaceStateOnce</code> will be stored in <code>replaceStateOnceKeys</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.replaceStateOnceKeys = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Keys passed into <code>replaceStateOn</code> will be stored in <code>replaceStateKeys</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.replaceStateKeys = [];
	<span class="hljs-keyword">this</span>.dispatchHandlers = <span class="hljs-keyword">this</span>.dispatchHandlers.bind(<span class="hljs-keyword">this</span>);
	<span class="hljs-keyword">this</span>.anchorClickHandler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
		PushstateObservable.prototype.anchorClickHandler.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>, event);
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3 id="keephash"><code>keepHash</code></h3>
<p>Currently is neither a feature that’s documented,
nor is it toggled. <a href="https://github.com/canjs/can-route-pushstate/issues/133">Issue #133</a>
is the discourse on it’s removal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.keepHash = <span class="hljs-literal">true</span>;
}

PushstateObservable.prototype = <span class="hljs-built_in">Object</span>.create(SimpleObservable.prototype);
PushstateObservable.constructor = PushstateObservable;
canReflect.assign(PushstateObservable.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3 id="root">root</h3>
<p>Start of <code>location.pathname</code> is the root.
(Can be configured via <code>route.urlData.root</code>)
The default is <code>&quot;#!&quot;</code> set in can-route-hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	root: <span class="hljs-string">"/"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3 id="matchslashes">matchSlashes</h3>
<p>The default is <code>false</code> set in can-route-hash.
Don’t greedily match slashes in routing rules.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	matchSlashes: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3 id="paramsmatcher">paramsMatcher</h3>
<p>Matches things like:</p>
<ul>
<li>?foo=bar</li>
<li>?foo=bar&amp;framework=canjs</li>
<li>?foo=&amp;bar=</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	paramsMatcher: <span class="hljs-regexp">/^\?(?:[^=]+=[^&amp;]*&amp;)*[^=]+=[^&amp;]*/</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="queryseparator">querySeparator</h3>
<p>Used in <code>can-route</code> for building regular expressions to match routes, or
return url substrings of routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	querySeparator: <span class="hljs-string">"?"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3 id="dispatchhandlers">dispatchHandlers</h3>
<p>Updates <code>this._value</code> to the current url and 
dispatches event handlers that are on the object.
<code>dispatchHandlers</code> is called if <code>pushState</code> or <code>replaceState</code>
are called, it is also an event handler on <code>&#39;popstate&#39;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	dispatchHandlers: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">var</span> old = <span class="hljs-keyword">this</span>._value;
		<span class="hljs-keyword">this</span>._value = getCurrentUrl();

		<span class="hljs-keyword">if</span> (old !== <span class="hljs-keyword">this</span>._value) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>PushstateObservable inherits from <code>SimpleObservable</code> which
is using the <code>can-event-queue/value/value</code> mixin, and is called
using the <code>can.dispatch</code> symbol.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">this</span>[dispatchSymbol](<span class="hljs-keyword">this</span>._value, old);
		}
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h3 id="anchorclickhandler">anchorClickHandler</h3>
<p>Handler function for <code>click</code> events.
Checks if a route is matched, if one is, calls <code>.pushState</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	anchorClickHandler: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node, event</span>) </span>{
		<span class="hljs-keyword">if</span> (!(event.isDefaultPrevented ? event.isDefaultPrevented() : event.defaultPrevented === <span class="hljs-literal">true</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If href has some JavaScript in it, let it run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (node.href === <span class="hljs-string">"javascript://"</span>) {
				<span class="hljs-keyword">return</span>;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Do not pushstate if target is for blank window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (node.target === <span class="hljs-string">"_blank"</span>) {
				<span class="hljs-keyword">return</span>;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Do not pushstate if meta key was pressed, mimicking standard browser behavior.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) {
				<span class="hljs-keyword">return</span>;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>linksHost is a Fix for IE showing blank host, but blank host means current host.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> linksHost = node.host || <span class="hljs-built_in">window</span>.location.host;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If link is within the same domain and descendant of <code>root</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.location.host === linksHost) {
				<span class="hljs-keyword">var</span> root = cleanRoot();</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>If the link is within the <code>root</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (node.pathname.indexOf(root) === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Removes root from url.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> nodePathWithSearch = node.pathname + node.search,
						url = nodePathWithSearch.substr(root.length);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>If a matching route exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span> (route.rule(url) !== <span class="hljs-literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Makes it possible to have a link with a hash.
Calling .pushState will dispatch events, causing
<code>can-route</code> to update its data, and then try to set back
the url without the hash.  We need to retain that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span> (node.href.indexOf(<span class="hljs-string">"#"</span>) &gt;= <span class="hljs-number">0</span>) {
							<span class="hljs-keyword">this</span>.keepHash = <span class="hljs-literal">true</span>;
						}</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>We do not want to call preventDefault() if the link is to the
same page and just a different hash; see can-route-pushstate#75.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">var</span> windowPathWithSearch = <span class="hljs-built_in">window</span>.location.pathname + <span class="hljs-built_in">window</span>.location.search;
						<span class="hljs-keyword">var</span> shouldCallPreventDefault = nodePathWithSearch !== windowPathWithSearch || node.hash === <span class="hljs-built_in">window</span>.location.hash;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Test if you can preventDefault.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span> (shouldCallPreventDefault &amp;&amp; event.preventDefault) {
							event.preventDefault();
						}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Update <code>window.location</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-built_in">window</span>.history.pushState(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, node.href);
					}
				}
			}
		}
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3 id="onbound">onBound</h3>
<p>Initalizes this._value.
Sets up event listeners to capture <code>click</code> events on <code>&lt;a&gt;</code> elements.
Overwrites the history api methods <code>.pushState</code> and <code>.replaceState</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	onBound: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>if running in Node.js, don’t setup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (isNode()) {
			<span class="hljs-keyword">return</span>;
		}

		<span class="hljs-keyword">var</span> <span class="hljs-built_in">document</span> = getDocument(),
			<span class="hljs-built_in">window</span> = getGlobal();

		<span class="hljs-keyword">this</span>._value = getCurrentUrl();</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Intercept routable links.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		domEvents.addDelegateListener(<span class="hljs-built_in">document</span>.documentElement, <span class="hljs-string">"click"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-keyword">this</span>.anchorClickHandler);
		<span class="hljs-keyword">var</span> originalMethods = <span class="hljs-keyword">this</span>.originalMethods = {};
		<span class="hljs-keyword">var</span> dispatchHandlers = <span class="hljs-keyword">this</span>.dispatchHandlers;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Rewrites original <code>pushState</code>/<code>replaceState</code> methods on <code>history</code>
and keeps pointer to original methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		canReflect.eachKey(methodsToOverwrite, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method</span>) </span>{
			<span class="hljs-keyword">this</span>.originalMethods[method] = <span class="hljs-built_in">window</span>.history[method];
			<span class="hljs-built_in">window</span>.history[method] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state, title, url</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Avoid doubled history states (with pushState).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> absolute = url.indexOf(<span class="hljs-string">"http"</span>) === <span class="hljs-number">0</span>;
				<span class="hljs-keyword">var</span> location = LOCATION();
				<span class="hljs-keyword">var</span> searchHash = location.search + location.hash;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>If url differs from current call original history method and update <code>route</code> state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> ((!absolute &amp;&amp; url !== location.pathname + searchHash) ||
					(absolute &amp;&amp; url !== location.href + searchHash)) {
					originalMethods[method].apply(<span class="hljs-built_in">window</span>.history, <span class="hljs-built_in">arguments</span>);
					dispatchHandlers();
				}
			};
		}, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Bind dispatchHandlers to the <code>popstate</code> event, so they will fire
when <code>history.back()</code> or <code>history.forward()</code> methods are called.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		domEvents.addEventListener(<span class="hljs-built_in">window</span>, <span class="hljs-string">"popstate"</span>, <span class="hljs-keyword">this</span>.dispatchHandlers);
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h3 id="onunbound">onUnbound</h3>
<p>removes the event listerns for capturing routable links.
Sets <code>.pushState</code> and <code>.replacState</code> to their original methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	onUnbound: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>If running in Node.js, don’t teardown.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(isNode()) {
			<span class="hljs-keyword">return</span>;
		}

		<span class="hljs-keyword">var</span> <span class="hljs-built_in">document</span> = getDocument(),
			<span class="hljs-built_in">window</span> = getGlobal();

		domEvents.removeDelegateListener(<span class="hljs-built_in">document</span>.documentElement, <span class="hljs-string">"click"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-keyword">this</span>.anchorClickHandler);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Reset the changed <code>window.history</code> methods to their original values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		canReflect.eachKey(methodsToOverwrite, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method</span>) </span>{
			<span class="hljs-built_in">window</span>.history[method] = <span class="hljs-keyword">this</span>.originalMethods[method];
		}, <span class="hljs-keyword">this</span>);

		domEvents.removeEventListener(<span class="hljs-built_in">window</span>, <span class="hljs-string">"popstate"</span>, <span class="hljs-keyword">this</span>.dispatchHandlers);
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <h3 id="get">get</h3>
<p>Allows <code>PushstateObservable</code> to be observable by can-observations,
and returns the current url.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"></span>) </span>{
		ObservationRecorder.add(<span class="hljs-keyword">this</span>);
		<span class="hljs-keyword">return</span> getCurrentUrl();
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h3 id="set">set</h3>
<p>Calls either pushState or replaceState on the difference
in properties between <code>oldProps</code> and <code>newProps</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>) </span>{
		<span class="hljs-keyword">var</span> newProps = route.deparam(path),
			oldProps = route.deparam(getCurrentUrl()),
			method = <span class="hljs-string">"pushState"</span>,
			changed = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Adds window.location.hash to path if it’s not already in path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.keepHash &amp;&amp; path.indexOf(<span class="hljs-string">"#"</span>) === <span class="hljs-number">-1</span> &amp;&amp; <span class="hljs-built_in">window</span>.location.hash) {
			path += <span class="hljs-built_in">window</span>.location.hash;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>The old state and new state are diffed 
to figure out which keys are changing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		diffObject(oldProps, newProps)
			.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">patch</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p><code>patch.key</code> refers to the mutated property name on <code>newProps</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">return</span> changed[patch.key] = <span class="hljs-literal">true</span>;
			});</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>If any of the changed properties are in <code>replaceStateKeys</code> or 
<code>replaceStateOnceKeys</code> change the method to <code>&#39;replaceState&#39;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.replaceStateKeys.length) {
			<span class="hljs-keyword">this</span>.replaceStateKeys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">replaceKey</span>) </span>{
				<span class="hljs-keyword">if</span> (changed[replaceKey]) {
					method = <span class="hljs-string">"replaceState"</span>;
				}
			});
		}
		
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.replaceStateOnceKeys.length) {
			<span class="hljs-keyword">this</span>.replaceStateOnceKeys
				.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">replaceOnceKey, index, thisArray</span>) </span>{
					<span class="hljs-keyword">if</span> (changed[replaceOnceKey]) {
						method = <span class="hljs-string">"replaceState"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Remove so we don’t attempt to replace 
the state on this key again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						thisArray.splice(index, <span class="hljs-number">1</span>);
					}
				});
		}
		<span class="hljs-built_in">window</span>.history[method](<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, bindingProxy.call(<span class="hljs-string">"root"</span>) + path);
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <h3 id="replacestateon">replaceStateOn</h3>
<p>Adds given arguments to <code>this.replaceStateKeys</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	replaceStateOn: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		canReflect.addValues(<span class="hljs-keyword">this</span>.replaceStateKeys, canReflect.toArray(<span class="hljs-built_in">arguments</span>));
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <h3 id="replacestateonce">replaceStateOnce</h3>
<p>Adds given arguments to <code>this.replaceStateOnceKeys</code>.
Keys in <code>this.replaceStateOnceKeys</code> will be removed
from the array the first time a changed route contains that key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	replaceStateOnce: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		canReflect.addValues(<span class="hljs-keyword">this</span>.replaceStateOnceKeys, canReflect.toArray(<span class="hljs-built_in">arguments</span>));
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h3 id="replacestateoff">replaceStateOff</h3>
<p>Removes given arguments from both <code>this.replaceStateKeys</code> and
<code>this.replaceOnceKeys</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	replaceStateOff: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		canReflect.removeValues(<span class="hljs-keyword">this</span>.replaceStateKeys, canReflect.toArray(<span class="hljs-built_in">arguments</span>));
		canReflect.removeValues(<span class="hljs-keyword">this</span>.replaceStateOnceKeys, canReflect.toArray(<span class="hljs-built_in">arguments</span>));
	}
});

canReflect.assignSymbols(PushstateObservable.prototype, {
	<span class="hljs-string">"can.getValue"</span>: PushstateObservable.prototype.get,
	<span class="hljs-string">"can.setValue"</span>: PushstateObservable.prototype.set,
});

<span class="hljs-built_in">module</span>.exports = PushstateObservable;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
